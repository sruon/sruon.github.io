---js
const eleventyNavigation = {
  key: "Parser",
  order: 2
};
const layout = "layouts/base.njk";
const title = "Actions Parser";
---

{% css %}
.packet-header { cursor: pointer; }
.packet-content { display: none; }
.packet.open .packet-content { display: block; }
{% endcss %}

<div class="container">
  <h1 class="title">Actions Parser</h1>

  <div class="field">
    <label class="label" for="textInput">Paste packets here</label>
    <div class="control">
      <textarea id="textInput" class="textarea" rows="10" placeholder="[2025-11-08 05:48:09.339] Packet 0x028
        |  0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F      | 0123456789ABCDEF
    -----------------------------------------------------  ----------------------
      0 | 28 14 5C 05 1F 73 6D 0C 00 01 E4 58 58 1A DD 00    0 | (.\\..sm....XX...
      1 | 00 00 C0 5C 1B 03 40 00 1A 00 60 01 02 07 00 00    1 | ...\\..@...`.....
      2 | 00 00 00 00 00 00 00 00 -- -- -- -- -- -- -- --    2 | ........--------"></textarea>
    </div>
  </div>

  <div id="results"></div>
</div>

<template id="packet-template">
  <div class="box packet mb-4">
    <div class="packet-header is-flex is-align-items-center" style="gap: 0.5rem;">
      <span class="tag is-light timestamp"></span>
      <span class="tag is-primary action-name"></span>
      <span class="summary"></span>
      <a href="#" class="button is-small is-link is-light share-link ml-auto">link</a>
    </div>
    <div class="packet-content mt-4">
      <h5 class="subtitle is-5">Raw Bytes (<span class="byte-count"></span> bytes)</h5>
      <pre><code class="raw-bytes"></code></pre>

      <h5 class="subtitle is-5">Details</h5>
      <ul class="details">
        <li>Caster: <code class="caster"></code></li>
        <li>Action: <span class="action-detail"></span></li>
        <li>Targets: <span class="targets"></span></li>
        <li>Command Arg: <code class="cmd-arg"></code></li>
      </ul>

      <h5 class="subtitle is-5">Lua Format</h5>
      <pre><code class="lua-format"></code></pre>
    </div>
  </div>
</template>

{% js %}
import { parseAction, getActionName, getMissName } from '/js/actionparser.js'

const textInput = document.getElementById('textInput')
const results = document.getElementById('results')

function parseHexDump(text) {
  const packets = []
  const lines = text.split('\n')
  let currentPacket = []
  let currentTimestamp = null

  for (const line of lines) {
    if (line.includes('Packet 0x')) {
      if (currentPacket.length > 0) {
        packets.push({ bytes: currentPacket, timestamp: currentTimestamp })
        currentPacket = []
      }

      const timestampMatch = line.match(/\[([^\]]+)\]/)
      currentTimestamp = timestampMatch ? timestampMatch[1] : null
      continue
    }

    const parts = line.split('|')
    if (parts.length >= 3) {
      const hexSection = parts[1].trim()
      const hexBytes = hexSection.split(/\s+/)

      for (const hex of hexBytes) {
        if (hex !== '--' && hex.match(/^[0-9A-Fa-f]{2}$/)) {
          currentPacket.push(parseInt(hex, 16))
        }
      }
    }
  }

  if (currentPacket.length > 0) {
    packets.push({ bytes: currentPacket, timestamp: currentTimestamp })
  }

  return packets
}

function generateSummary(action) {
  const casterId = action.m_uID.toString()

  if (action.target.length === 0) {
    return `Caster: ${casterId}`
  }

  const targetId = action.target[0].m_uID.toString()
  const targetCount = action.target.length

  if (action.cmd_no === 8) {
    const subKind = action.target[0]?.result[0]?.sub_kind
    if (subKind !== undefined) {
      const targetStr = targetCount > 1 ? `${targetId} +${targetCount - 1}` : targetId
      return `${casterId} → ${targetStr} (spell: ${subKind})`
    }
  }

  const targetStr = targetCount > 1 ? `${targetId} +${targetCount - 1}` : targetId
  return `${casterId} → ${targetStr}`
}

function cmdArgToString(cmdArg) {
  if (cmdArg === 0) return ''

  const bytes = [
    cmdArg & 0xFF,
    (cmdArg >> 8) & 0xFF,
    (cmdArg >> 16) & 0xFF,
    (cmdArg >> 24) & 0xFF
  ]

  const str = bytes
    .map(b => b > 0 ? String.fromCharCode(b) : '')
    .join('')
    .replace(/\0/g, '')

  return str.match(/^[a-zA-Z0-9_]+$/) ? str : ''
}

function parseScale(scale) {
  const distortion = scale & 0b11           // lower 2 bits
  const knockback = (scale >> 2) & 0b111    // upper 3 bits
  return { knockback, distortion }
}

function formatActionAsLua(action) {
  const cmdArgStr = cmdArgToString(action.cmd_arg)
  const cmdArgComment = cmdArgStr ? ` -- "${cmdArgStr}"` : ''

  return `{
    m_uID   = ${action.m_uID},
    trg_sum = ${action.trg_sum},
    res_sum = ${action.res_sum},
    cmd_no  = ${action.cmd_no}, -- ${getActionName(action.cmd_no)}
    cmd_arg = ${action.cmd_arg},${cmdArgComment}
    info    = ${action.info},
    target  =
    {
${action.target.map(target => `        {
            m_uID      = ${target.m_uID},
            result_sum = ${target.result_sum},
            result     =
            {
${target.result.map(result => {
                const scaleData = parseScale(result.scale)
                return `                {
                    miss          = ${result.miss}, -- ${getMissName(result.miss)}
                    kind          = ${result.kind},
                    sub_kind      = ${result.sub_kind},
                    info          = ${result.info},
                    scale         = ${result.scale}, -- knockback: ${scaleData.knockback}, distortion: ${scaleData.distortion}
                    value         = ${result.value},
                    message       = ${result.message},
                    bit           = ${result.bit},
                    has_proc      = ${result.has_proc},
                    proc_kind     = ${result.proc_kind},
                    proc_info     = ${result.proc_info},
                    proc_value    = ${result.proc_value},
                    proc_message  = ${result.proc_message},
                    has_react     = ${result.has_react},
                    react_kind    = ${result.react_kind},
                    react_info    = ${result.react_info},
                    react_value   = ${result.react_value},
                    react_message = ${result.react_message},
                }`
              }).join(',\n')},
            },
        }`).join(',\n')},
    },
}`
}

function formatBytes(bytes) {
  return bytes.map((b, i) => {
    const hex = '0x' + b.toString(16).padStart(2, '0').toUpperCase()
    return i % 16 === 0 ? (i > 0 ? '\n' + hex : hex) : ' ' + hex
  }).join('')
}

function renderPackets(text) {
  if (!text.trim()) {
    results.innerHTML = ''
    return
  }

  const packets = parseHexDump(text)
  const parsed = packets
    .map(packet => {
      try {
        const action = parseAction(packet.bytes)
        if (action) {
          return { bytes: packet.bytes, action, timestamp: packet.timestamp }
        }
        return null
      } catch (err) {
        return null
      }
    })
    .filter(packet => packet !== null)

  if (parsed.length === 0) {
    results.innerHTML = ''
    return
  }

  // Clear previous results
  results.innerHTML = `<h2 class="title is-4 mt-5">Parsed Packets (${parsed.length})</h2>`

  const template = document.getElementById('packet-template')

  parsed.forEach((packet, idx) => {
    const clone = template.content.cloneNode(true)
    const box = clone.querySelector('.packet')
    box.id = `packet-${idx}`

    // Set timestamp
    const timestampEl = clone.querySelector('.timestamp')
    if (packet.timestamp) {
      timestampEl.textContent = packet.timestamp
    } else {
      timestampEl.remove()
    }

    // Set action name and summary
    clone.querySelector('.action-name').textContent = getActionName(packet.action.cmd_no)
    clone.querySelector('.summary').textContent = generateSummary(packet.action)

    // Set share link
    const hexString = packet.bytes.map(b => b.toString(16).padStart(2, '0')).join('')
    const shareLink = clone.querySelector('.share-link')
    shareLink.href = `/actions/#${hexString}`
    shareLink.onclick = (e) => e.stopPropagation()

    // Set header click handler
    const header = clone.querySelector('.packet-header')
    header.onclick = (e) => {
      if (e.target.tagName !== 'A') {
        box.classList.toggle('open')
      }
    }

    // Set content
    clone.querySelector('.byte-count').textContent = packet.bytes.length
    clone.querySelector('.raw-bytes').textContent = formatBytes(packet.bytes)
    clone.querySelector('.caster').textContent = packet.action.m_uID
    clone.querySelector('.action-detail').textContent = `${getActionName(packet.action.cmd_no)} (cmd_no: ${packet.action.cmd_no})`
    clone.querySelector('.targets').textContent = packet.action.trg_sum
    clone.querySelector('.cmd-arg').textContent = packet.action.cmd_arg
    clone.querySelector('.lua-format').textContent = formatActionAsLua(packet.action)

    results.appendChild(clone)
  })
}

textInput.addEventListener('input', (e) => {
  renderPackets(e.target.value)
})
{% endjs %}
