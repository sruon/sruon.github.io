---js
const layout = "layouts/base.njk";
const title = "Action Details";
const permalink = "/actions/";
---

{% css %}
/* Bulma handles styling */
{% endcss %}

<div class="container">
  <h1 class="title">Action Details</h1>

  <div id="content">
    <p>Loading packet data from URL...</p>
  </div>
</div>

{% js %}
import { parseAction, getActionName, getMissName } from '/js/actionparser.js'

function hexToBytes(hex) {
  const bytes = []
  for (let i = 0; i < hex.length; i += 2) {
    bytes.push(parseInt(hex.substr(i, 2), 16))
  }
  return bytes
}

function formatBytes(bytes) {
  return bytes.map((b, i) => {
    const hex = '0x' + b.toString(16).padStart(2, '0').toUpperCase()
    return i % 16 === 0 ? (i > 0 ? '\n' + hex : hex) : ' ' + hex
  }).join('')
}

function cmdArgToString(cmdArg) {
  if (cmdArg === 0) return ''

  const bytes = [
    cmdArg & 0xFF,
    (cmdArg >> 8) & 0xFF,
    (cmdArg >> 16) & 0xFF,
    (cmdArg >> 24) & 0xFF
  ]

  const str = bytes
    .map(b => b > 0 ? String.fromCharCode(b) : '')
    .join('')
    .replace(/\0/g, '')

  return str.match(/^[a-zA-Z0-9_]+$/) ? str : ''
}

function parseScale(scale) {
  const distortion = scale & 0b11           // lower 2 bits
  const knockback = (scale >> 2) & 0b111    // upper 3 bits
  return { knockback, distortion }
}

function formatActionAsLua(action) {
  const cmdArgStr = cmdArgToString(action.cmd_arg)
  const cmdArgComment = cmdArgStr ? ` -- "${cmdArgStr}"` : ''

  return `{
    m_uID   = ${action.m_uID},
    trg_sum = ${action.trg_sum},
    res_sum = ${action.res_sum},
    cmd_no  = ${action.cmd_no}, -- ${getActionName(action.cmd_no)}
    cmd_arg = ${action.cmd_arg},${cmdArgComment}
    info    = ${action.info},
    target  =
    {
${action.target.map(target => `        {
            m_uID      = ${target.m_uID},
            result_sum = ${target.result_sum},
            result     =
            {
${target.result.map(result => {
                const scaleData = parseScale(result.scale)
                return `                {
                    miss          = ${result.miss}, -- ${getMissName(result.miss)}
                    kind          = ${result.kind},
                    sub_kind      = ${result.sub_kind},
                    info          = ${result.info},
                    scale         = ${result.scale}, -- knockback: ${scaleData.knockback}, distortion: ${scaleData.distortion}
                    value         = ${result.value},
                    message       = ${result.message},
                    bit           = ${result.bit},
                    has_proc      = ${result.has_proc},
                    proc_kind     = ${result.proc_kind},
                    proc_info     = ${result.proc_info},
                    proc_value    = ${result.proc_value},
                    proc_message  = ${result.proc_message},
                    has_react     = ${result.has_react},
                    react_kind    = ${result.react_kind},
                    react_info    = ${result.react_info},
                    react_value   = ${result.react_value},
                    react_message = ${result.react_message},
                }`
              }).join(',\n')},
            },
        }`).join(',\n')},
    },
}`
}

function generateSummary(action) {
  const casterId = action.m_uID.toString()

  if (action.target.length === 0) {
    return `Caster: ${casterId}`
  }

  const targetId = action.target[0].m_uID.toString()
  const targetCount = action.target.length

  if (action.cmd_no === 8) {
    const subKind = action.target[0]?.result[0]?.sub_kind
    if (subKind !== undefined) {
      const targetStr = targetCount > 1 ? `${targetId} +${targetCount - 1}` : targetId
      return `${casterId} → ${targetStr} (spell: ${subKind})`
    }
  }

  const targetStr = targetCount > 1 ? `${targetId} +${targetCount - 1}` : targetId
  return `${casterId} → ${targetStr}`
}

const contentDiv = document.getElementById('content')
const hash = window.location.hash.substring(1)

if (!hash) {
  contentDiv.innerHTML = '<div class="notification is-warning">No packet data in URL. Use a link from the parser page.</div>'
} else {
  try {
    const bytes = hexToBytes(hash)
    const action = parseAction(bytes)

    if (!action) {
      contentDiv.innerHTML = '<div class="notification is-danger">Invalid packet: First byte must be 0x28</div>'
    } else {
      contentDiv.innerHTML = `
        <div class="box">
          <h2 class="title is-4">${getActionName(action.cmd_no)}: ${generateSummary(action)}</h2>

          <h3 class="subtitle is-5">Raw Bytes (${bytes.length} bytes)</h3>
          <pre><code>${formatBytes(bytes)}</code></pre>

          <h3 class="subtitle is-5">Details</h3>
          <ul>
            <li>Caster: <code>${action.m_uID}</code></li>
            <li>Action: ${getActionName(action.cmd_no)} (cmd_no: ${action.cmd_no})</li>
            <li>Targets: ${action.trg_sum}</li>
            <li>Command Arg: <code>${action.cmd_arg}</code></li>
          </ul>

          <h3 class="subtitle is-5">Lua Format</h3>
          <pre><code>${formatActionAsLua(action)}</code></pre>
        </div>
      `
    }
  } catch (err) {
    contentDiv.innerHTML = `<div class="notification is-danger">Failed to parse packet: ${err.message}</div>`
  }
}
{% endjs %}
